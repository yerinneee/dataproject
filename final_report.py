# -*- coding: utf-8 -*-
"""final_report.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1xwjEOSEaWcZE6GDZ0rFatXEO1imR3xer
"""

#ì „ì²˜ë¦¬
import re
import pandas as pd
import numpy as np
#ì‹œê°í™”
import streamlit as st
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
# ì§€ë„
import folium
import geopandas as gpd
from folium.plugins import Draw
from folium.features import CustomIcon
from streamlit_folium import folium_static

sns.set_theme(style='whitegrid', font_scale=1.5)
sns.set_palette("pastel", n_colors=10)
plt.rc('font', family='Malgun Gothic')
plt.rc('axes', unicode_minus=False)

st.set_page_config(
    page_title="ìœ ê¸°ë™ë¬¼, ë³´í˜¸ì†Œ í˜„í™©",
    page_icon="ğŸ¦”",
    layout="centered")

st.sidebar.title('ğŸ¾ ëŒ€ì‹œë³´ë“œ ğŸ¾')
st.sidebar.caption('ì´ ë¬¸ì„œëŠ” ìœ ê¸°ë™ë¬¼ ë° ë³´í˜¸ì†Œ ê´€ë ¨ ë°ì´í„°ì™€ ë¶„ì„ ë ˆí¬íŠ¸ê°€ í˜ì´ì§€ë¡œ êµ¬ë¶„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.')

radio = st.sidebar.radio("ğŸ‘‡ì—´ëŒí•˜ì‹¤ ë ˆí¬íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”",
    ('Overview', 'Report', 'Advanced Report'))

@st.cache_data
def load_geodata():
    geojson_path = 'TL_SCCO_CTPRVN.json'
    gdf = gpd.read_file(geojson_path, encoding='utf-8')
    return gdf
gdf = load_geodata()
@st.cache_data(hash_funcs={pd.read_csv: lambda _: None})
def load_data():
    df = pd.read_csv('abandon_animal_geo2.csv')
    #ë³´í˜¸ì†Œ ì´ë¦„ ì „ì²˜ë¦¬ ()ê´„í˜¸ ì—†ì• ê¸°
    df['careNm'] = df['careNm'].apply(lambda x: re.sub(r'\([^)]*\)', '', x))
    #ë°œìƒì¼ì ë‚ ì§œ íƒ€ì…ìœ¼ë¡œ ë³€ê²½
    df['happenDt'] = pd.to_datetime(df['happenDt'], format='%Y%m%d')
    #processState ê°„ì†Œí™”
    df['processState_class'] = df['processState'].replace({ 'ì¢…ë£Œ(ìì—°ì‚¬)': 'Death',
                                                            'ì¢…ë£Œ(ì•ˆë½ì‚¬)': 'Death',
                                                            'ì¢…ë£Œ(ë°˜í™˜)': 'Alive',
                                                            'ì¢…ë£Œ(ê¸°ì¦)': 'Alive',
                                                            'ì¢…ë£Œ(ì…ì–‘)': 'Alive',
                                                            'ì¢…ë£Œ(ë°©ì‚¬)': 'Alive',
                                                            'ì¢…ë£Œ(ê¸°íƒ€)': 'Alive',
                                                            'ë³´í˜¸ì¤‘': 'Under care'})
    return df

df = load_data()
if radio == 'Overview':
    st.title('Overview')
    st.caption("Data Range: 20210221 ~ 20240220")

    with st.sidebar.container():
        st.markdown("[1. ìœ ê¸°ë™ë¬¼ í˜„í™©](#1._ìœ ê¸°ë™ë¬¼_í˜„í™©)", unsafe_allow_html=True)
        st.markdown("[2. ë³´í˜¸ì†Œ í˜„í™©](#2._ë³´í˜¸ì†Œ_í˜„í™©)", unsafe_allow_html=True)

    st.header('1. ìœ ê¸°ë™ë¬¼ í˜„í™©', anchor = '1._ìœ ê¸°ë™ë¬¼_í˜„í™©')
    st.metric(label="ì „ì²´ ìœ ê¸°ë™ë¬¼ ìˆ˜", value='%d' % len(df))

    df1, df2 = st.columns((3, 2))
    with df1:
        multiselect_year = st.multiselect('Year',
                                      df['happenDt'].dt.year.unique().tolist(),
                                      default=df['happenDt'].dt.year.unique().tolist()[3])
    with df2:
        filtered_df = df[df['happenDt'].dt.year.isin(multiselect_year)]
        yearly_animal_count_filtered = filtered_df.groupby(filtered_df['happenDt'].dt.year).size()
        yearly_animal_count_filtered = yearly_animal_count_filtered.reindex(multiselect_year)
        yearly_animal_count_filtered.index.name = 'ì—°ë„'
        st.metric(label="ì„ íƒëœ ì—°ë„ ìœ ê¸°ë™ë¬¼ ìˆ˜", value='%d' % yearly_animal_count_filtered.sum())

    fig = px.bar(
        yearly_animal_count_filtered,
        x=yearly_animal_count_filtered.index,
        y=yearly_animal_count_filtered.values,
        labels={'x':'ì—°ë„', 'y':'ìœ ê¸°ë™ë¬¼ ìˆ˜'},
        title='ì„ íƒ ì—°ë„ ìœ ê¸°ë™ë¬¼ ìˆ˜',
        color=yearly_animal_count_filtered.index

    )
    fig.update_layout(xaxis={'type': 'category'}) #ë‚ ì§œí˜•ìœ¼ë¡¤ ì²˜ë¦¬ ì•ˆí•˜ê³  ì¹´í…Œê³ ë¦¬í˜•ìœ¼ë¡œ ì²˜ë¦¬í•´ì¤Œ
    fig.update_traces(hoverlabel=dict(font=dict(size=16))) # íˆ´íŒì˜ ê¸€ì í¬ê¸°ë¥¼ 16ìœ¼ë¡œ ì§€ì •
    fig.update_layout(yaxis=dict(range=[95000, 115000])) #yì¶• ë²”ìœ„ ì„¤ì •
    fig.update_layout(coloraxis_showscale=False)
    fig.update_traces(hovertemplate='ì—°ë„: %{x}<br>ìœ ê¸°ë™ë¬¼ ìˆ˜: %{y}')
    st.plotly_chart(fig)

    st.header('2. ë³´í˜¸ì†Œ í˜„í™©',anchor = '2._ë³´í˜¸ì†Œ_í˜„í™©')
    st.metric(label="ì „ì²´ ë³´í˜¸ì†Œ ìˆ˜", value='%d' % len(df[['lat', 'lng']].drop_duplicates()))

    df1, df2 = st.columns((1, 1))
    with df1:
        multiselect_year = st.multiselect('Year',
                                          df['happenDt'].dt.year.unique().tolist(),
                                          default=df['happenDt'].dt.year.unique().tolist()[:4],
                                          key='year_multiselect')  # Unique key added here
    with df2:
        filtered_df = df[df['happenDt'].dt.year.isin(multiselect_year)]
        yearly_shelter_filtered = filtered_df.groupby(filtered_df['happenDt'].dt.year)['careNm'].nunique()
        yearly_shelter_filtered.index.name = 'ì—°ë„'
        st.metric(label="ì„ íƒ ì—°ë„ ë³´í˜¸ì†Œ ìˆ˜", value='%d' % len(df[['lat', 'lng']].drop_duplicates()))



    fig = px.bar(
        x=yearly_shelter_filtered.index,
        y=yearly_shelter_filtered.values,
        labels={'x': 'ì—°ë„', 'y': 'ë³´í˜¸ì†Œ ìˆ˜'},
        title='ì„ íƒ ì—°ë„ ë³´í˜¸ì†Œ ìˆ˜',
        color=yearly_shelter_filtered.index


        )
    fig.update_layout(xaxis={'type': 'category'})
    fig.update_traces(hovertemplate='ì—°ë„: %{x}<br> ë³´í˜¸ì†Œ ìˆ˜: %{y}')


    st.plotly_chart(fig)

elif radio == 'Report':
    with st.sidebar.container():
        st.markdown("[1. ìœ ê¸°ë™ë¬¼ í˜„í™©](#1._ìœ ê¸°ë™ë¬¼_í˜„í™©)", unsafe_allow_html=True)
        st.markdown("[2. ìœ ê¸°ë™ë¬¼ ì…ì–‘](#2._ìœ ê¸°ë™ë¬¼_ì…ì–‘)", unsafe_allow_html=True)
        st.markdown("[3. ë³´í˜¸ì†Œ ë³„ ì…ì–‘ ìˆ˜](#3._ë³´í˜¸ì†Œ_ë³„_ì…ì–‘_ìˆ˜)", unsafe_allow_html=True)

    st.write(f'# Report')
    st.header('1. ìœ ê¸°ë™ë¬¼ í˜„í™©', anchor = '1._ìœ ê¸°ë™ë¬¼_í˜„í™©')
    st.caption('ë°ì´í„° êµ¬ê°„: 202102~202402')
    col1, col2 = st.columns([1, 3])
    selected_option = col1.radio("íŒŒì´ ì°¨íŠ¸ ì„ íƒ", ["ìœ ê¸°ë™ë¬¼ í˜„í™©", "ì¤‘ì„±í™”", "ì„±ë³„"])
    if selected_option == "ìœ ê¸°ë™ë¬¼ í˜„í™©":
        process_state_counts = df["processState_class"].value_counts()
        fig = px.pie(process_state_counts, values=process_state_counts.values, names=process_state_counts.index)
        fig.update_traces(textfont_size=16, textposition='inside')
        fig.update_layout(legend_font_size=16)
        col2.plotly_chart(fig)
    elif selected_option == "ì¤‘ì„±í™”":
        neuter_counts = df['neuterYn'].value_counts()
        labels_map = {'Y': 'Yes', 'N': 'No', 'U': 'Unknown'}
        neuter_counts.index = [labels_map[label] for label in neuter_counts.index]
        fig = px.pie(neuter_counts, values=neuter_counts.values, names=neuter_counts.index)
        fig.update_traces(textfont_size=16, textposition='inside')
        fig.update_layout(legend_font_size=16)
        col2.plotly_chart(fig)
    elif selected_option == "ì„±ë³„":
        sex_counts = df["sexCd"].value_counts()
        labels_map = {'M': 'male', 'F': 'female', 'Q': 'unknown'}
        sex_counts.index = [labels_map[label] for label in sex_counts.index]
        fig = px.pie(sex_counts, values=sex_counts.values, names=sex_counts.index)
        fig.update_traces(textfont_size=16, textposition='inside')
        fig.update_layout(legend_font_size=16)
        col2.plotly_chart(fig)

    st.header('2. ìœ ê¸°ë™ë¬¼ ì…ì–‘', anchor='2._ìœ ê¸°ë™ë¬¼_ì…ì–‘')
    col1, col2 = st.columns([1, 3])
    selected_option = col1.radio("ê·¸ë˜í”„ ì„ íƒ", ["ì¤‘ì„±í™” ì—¬ë¶€", "ì„±ë³„"])
    if selected_option == "ì¤‘ì„±í™” ì—¬ë¶€":
        grouped_data = df.groupby(['processState_class', 'neuterYn']).size().unstack(fill_value=0)
        grouped_data = grouped_data.rename(columns={'U': 'ì•Œ ìˆ˜ ì—†ìŒ', 'Y': 'ì¤‘ì„±í™”', 'N': 'ì¤‘ì„±í™”ë˜ì§€ ì•ŠìŒ'})
        fig = px.bar(grouped_data, barmode='stack')
        fig.update_traces(textfont=dict(size=16))
        fig.update_layout(title='ìœ ê¸°ë™ë¬¼ ìƒíƒœë³„ ì¤‘ì„±í™” ì—¬ë¶€', xaxis_title='ìœ ê¸°ë™ë¬¼ ìƒíƒœ', yaxis_title='ë¹ˆë„', legend_title='ì¤‘ì„±í™” ì—¬ë¶€',legend_font_size=16)
        col2.plotly_chart(fig)
    elif selected_option == "ì„±ë³„":
        grouped_data = df.groupby(['processState_class', 'sexCd']).size().unstack(fill_value=0)
        fig = px.bar(grouped_data, barmode='stack')
        fig.update_traces(textfont=dict(size=16))
        fig.update_layout(title='ìœ ê¸°ë™ë¬¼ ìƒíƒœë³„ ì„±ë³„', xaxis_title='ìœ ê¸°ë™ë¬¼ ìƒíƒœ', yaxis_title='ë¹ˆë„', legend_title='ì„±ë³„',legend_font_size=16)
        col2.plotly_chart(fig)

    st.header('3. ë³´í˜¸ì†Œ ë³„ ì…ì–‘ ìˆ˜', anchor='3._ë³´í˜¸ì†Œ_ë³„_ì…ì–‘_ìˆ˜')
    df_sorted = df[df['processState_class'] == 'Alive'].groupby(['careNm','lat','lng']).size().reset_index(name='Adoptions').sort_values(by='Adoptions', ascending = False)
    df_sorted
    mymap = folium.Map(location=[36.5, 127.5], zoom_start=6.5, tiles='cartodbpositron')
    df_sorted = df_sorted = df[df['processState_class'] == 'Alive'].groupby(['careNm','lat','lng']).size().reset_index(name='Adoptions').sort_values(by='Adoptions', ascending = False)
    for idx, row in df_sorted.iterrows():
        tooltip_text = f"{row['careNm']} ({row['Adoptions']} ê°œ ì…ì–‘)"
        folium.CircleMarker(
            location=[row['lat'], row['lng']],
            radius=row['Adoptions']/300,
            color='blue',
            fill=True,
            fill_color='blue',
            tooltip=tooltip_text
        ).add_to(mymap)
    folium_static(mymap)

elif radio == 'Advanced Report':
    st.write(f'# Advanced Report')
    st.header('1. ë³´í˜¸ì†Œ ì ìˆ˜')
    st.caption('ë°ì´í„° êµ¬ê°„: 202102~202402')
    df_sorted = df[df['processState_class'] == 'Alive'].groupby(['careNm','lat','lng']).size().reset_index(name='Adoptions').sort_values(by='Adoptions', ascending = False)
    conditions = [
        (df_sorted['Adoptions'] >= 800),
        (df_sorted['Adoptions'] <= 100),
        (df_sorted['Adoptions'] < 800) & (df_sorted['Adoptions'] >100)
        ]
    labels = ['Good', 'Bad', 'Okay']
    df_sorted['Adoptions_Group'] = np.select(conditions, labels)

    good, okay, bad = st.columns(3)
    with good:
        good_shelters = df_sorted[df_sorted['Adoptions_Group'] == 'Good']
        st.write(f'### GoodğŸ˜€: {good_shelters.shape[0]} ê°œ')
    with okay:
        okay_shelters = df_sorted[df_sorted['Adoptions_Group'] == 'Okay']
        st.write(f'### OkayğŸ˜: {okay_shelters.shape[0]} ê°œ')
    with bad:
        bad_shelters = df_sorted[df_sorted['Adoptions_Group'] == 'Bad']
        st.write(f'### BadğŸ™: {bad_shelters.shape[0]} ê°œ')

    option = st.selectbox('Select Data', ["Good", "Okay", "Bad"])
    f_df=df_sorted[df_sorted['Adoptions_Group'] == option]

    SuperShelter = st.sidebar.slider('SuperShelter',1,15,1)
    st.write('Top', SuperShelter,'in' )
    st.write(df_sorted[0:SuperShelter])

    mymap = folium.Map(location=[36.5, 127.5], zoom_start=6.5,tiles='cartodbpositron')
    Draw(export=True).add_to(mymap)

    folium.GeoJson(
        gdf,
        style_function=lambda x: {
            'color': 'black',  # ê²½ê³„ì„  ìƒ‰ìƒì„ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ì„¤ì •
            'fillColor': 'white',
            'weight': 5
        },
        name='geojson'
    ).add_to(mymap)

    link_url = "https://www.karma.or.kr/human_boardA/animal_board.php?act=list&bid=animal"

    for idx, row in f_df.iterrows():
        link_text = "Click here to visit Website"  # ë§í¬ í…ìŠ¤íŠ¸ ì„¤ì •
        popup_text = f"<div style='font-size: 8pt; font-weight: bold; width:200px; height: 60px;'>{row['careNm']}:<br> {row['Adoptions']}ê°œ<br><a href='{link_url}' target='_blank'>{link_text}</a></div>"
        tooltip_text = f"{row['careNm']} ({row['Adoptions']} ê°œ ì…ì–‘)"
        if option == "Good":
            icon = folium.Icon(color='blue', icon='smile', icon_color='white', prefix='fa')
        elif option == "Bad":
            icon = folium.Icon(color='red', icon='frown', icon_color='white', prefix='fa')
        else:
            icon = folium.Icon(color='green', icon='meh', icon_color='white', prefix='fa')
        # ë§ˆì»¤ ì¶”ê°€
        folium.Marker(
            location=[row['lat'], row['lng']],
            popup=popup_text,
            tooltip = tooltip_text,
            icon=icon
        ).add_to(mymap)

    # ì§€ë„ ì¶œë ¥
    folium_static(mymap)
    st.sidebar.text("----------------------------------")
    st.sidebar.text('ì‚°ëŒ€íŠ¹ ì‹œê°í™” í”„ë¡œì íŠ¸\n24ë…„ 3ì›” 4ì¼\n')
    st.sidebar.text('ê¶Œì¬í˜„\nì‹¬ì¬ìœ¤\nìœ ë™í›ˆ\nì •ì˜ˆë¦°')
    st.sidebar.text("----------------------------------")
    st.sidebar.text("ë°ì´í„° ì¶œì²˜:\nhttps://www.data.go.kr/")

